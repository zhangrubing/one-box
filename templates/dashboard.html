{% extends "base.html" %}{% set page_title="浠〃鐩? %}{% block content %}
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4" id="kpis">
  <div class="kpi card cpu">
    <div class="kpi-label">CPU 浣跨敤鐜?/div>
    <div class="kpi-value" id="cpuVal">-</div>
    <div class="kpi-pill"><span id="cpuInfo">-</span></div>
  </div>
  <div class="kpi card mem">
    <div class="kpi-label">鍐呭瓨鍗犵敤</div>
    <div class="kpi-value" id="memVal">-</div>
    <div class="kpi-pill"><span id="memTotal">-</span></div>
  </div>
  <div class="kpi card gpu">
    <div class="kpi-label">GPU 鎬讳綋鍒╃敤</div>
    <div class="kpi-value" id="gpuVal">-</div>
    <div class="kpi-pill"><span id="gpuInfo">-</span></div>
  </div>
  <div class="kpi card alerts">
    <div class="kpi-label">鍛婅锛?4h锛?/div>
    <div class="kpi-value" id="alertVal">-</div>
    <div class="kpi-pill"><span id="alertInfo">-</span></div>
  </div>
</div>

<div class="flex" style="gap:10px;align-items:center;margin-top:10px">
  <span class="small" style="color:var(--muted)">鏃堕棿鑼冨洿锛?/span>
  <div class="seg" id="rangeSeg">
    <button data-r="5m" class="on">鏈€杩?鍒嗛挓</button>
    <button data-r="1h">鏈€杩?灏忔椂</button>
    <button data-r="24h">鏈€杩?4灏忔椂</button>
  </div>
  <span class="mini-avg" id="avgCpu" style="margin-left:auto"></span>
  <span class="mini-avg" id="avgMem" style="margin-left:12px"></span>
  <span class="mini-avg" id="avgDisk" style="margin-left:12px"></span>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mt-2">
  <div class="card"><div class='section-title'><span>CPU 瀹炴椂鏇茬嚎 <span class='mini-avg'></span></span></div><canvas id='cpuChart' style='width:100%;height:220px'></canvas></div>
  <div class="card"><div class='section-title'><span>鍐呭瓨浣跨敤鐜囨洸绾?<span class='mini-avg'></span></span></div><canvas id='memChart' style='width:100%;height:220px'></canvas></div>
  <div class="card"><div class='section-title'><span>纾佺洏 IO锛圡B/s锛?<span class='mini-avg'></span></span></div><canvas id='diskChart' style='width:100%;height:220px'></canvas></div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
  <div class="card"><div class='section-title'><span>GPU 鍒╃敤鐜囷紙骞冲潎锛?/span></div><canvas id='gpuUtilChart' style='width:100%;height:220px'></canvas></div>
  <div class="card"><div class='section-title'><span>GPU 娓╁害锛堝钩鍧囷級</span></div><canvas id='gpuTempChart' style='width:100%;height:220px'></canvas></div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
  <div class="card">
    <div class="section-title"><span>鏈€杩戜弗閲嶅憡璀?/span></div>
    <table class="table"><thead><tr><th>ID</th><th>绾у埆</th><th>鏍囬</th><th>鏃堕棿</th><th>鐘舵€?/th></tr></thead><tbody id="sevAlerts"></tbody></table>
  </div>
  <div class="card">
    <div class="section-title"><span>杩涚▼ TOP锛圕PU 30s 閲囨牱锛?/span> <button class="btn" id="sampleTop" style="float:right">鍒锋柊閲囨牱</button></div>
    <div class="small">閲囨牱鏈熼棿璇风◢鍊欙紝璇峰嬁棰戠箒鐐瑰嚮</div>
    <table class="table"><thead><tr><th>PID</th><th>杩涚▼</th><th>鐢ㄦ埛</th><th>CPU%</th><th>鍐呭瓨</th></tr></thead><tbody id="procTop"></tbody></table>
  </div>
</div>

<script type="module">
import {mountSSE, apiGet, $, formatBytes} from "{{ url_for('static', path='assets/common.js') }}";
import { MiniLine } from "{{ url_for('static', path='assets/chart.js') }}";

const cpuVal=$("#cpuVal"), memVal=$("#memVal"), cpuInfo=$("#cpuInfo"), memTotal=$("#memTotal"), gpuVal=$("#gpuVal"), gpuInfo=$("#gpuInfo"), alertVal=$("#alertVal"), alertInfo=$("#alertInfo");
const sevAlerts=$("#sevAlerts"), procTop=$("#procTop");

// x 杞存椂闂村埢搴︼紙5 涓瓑鍒嗭級
function genXTicks(t0, t1){ const N=5, out=[]; for(let i=0;i<N;i++){ const p=i/(N-1); const dt=(t1-t0)*(1-p); let label='now'; if(dt>0){ if(dt>=3600) label=`-${Math.round(dt/3600)}h`; else if(dt>=60){ const m=Math.round((dt/60)*10)/10; label=`-${String(m).replace(/\.0$/,'')}m`; } else label=`-${Math.round(dt)}s`; } out.push({p,label}); } return out; }

// 鍥捐〃锛堝惎鐢?timeMode锛?
const cpuC=new MiniLine('cpuChart',{timeMode:true,max:720,yMin:0,yMax:100,axes:true,ticks:[0,20,40,60,80,100],xTicks:genXTicks});
const memC=new MiniLine('memChart',{timeMode:true,max:720,yMin:0,yMax:100,axes:true,ticks:[0,20,40,60,80,100],xTicks:genXTicks});
const diskC=new MiniLine('diskChart',{timeMode:true,max:720,yMin:0,yMax:50,axes:true,ticks:[0,10,20,30,40,50],xTicks:genXTicks});
const gpuUtilC=new MiniLine('gpuUtilChart',{timeMode:true,max:720,yMin:0,yMax:100,axes:true,ticks:[0,20,40,60,80,100],xTicks:genXTicks});
const gpuTempC=new MiniLine('gpuTempChart',{timeMode:true,max:720,yMin:0,yMax:100,axes:true,ticks:[0,20,40,60,80,100],xTicks:genXTicks});

// 涓婚鍒囨崲鏃讹紝绔嬪埢閲嶇粯鍧愭爣涓庣綉鏍硷紝閬垮厤棰滆壊寤惰繜
function redrawAllCharts(){
  try{ cpuC.draw(); memC.draw(); diskC.draw(); gpuUtilC.draw(); gpuTempC.draw(); }catch(e){}
}
try{
  const themeObserver = new MutationObserver((mutations)=>{
    for (const m of mutations){
      if (m.attributeName === 'data-theme'){ requestAnimationFrame(redrawAllCharts); break; }
    }
  });
  themeObserver.observe(document.documentElement, { attributes: true });
}catch(e){}

let range='5m';
let lastAvgCpu=0, lastAvgMem=0, lastAvgDisk=0; let sseRef=null;
let loadId=0; // 闃叉骞跺彂鍔犺浇瀵艰嚧鏃ф暟鎹鐩栨柊缁撴灉
const DEBUG_POPUPS = false; // 灞忚斀璋冭瘯寮圭獥锛堟敼涓?true 鎵嶄細寮瑰嚭锛?let winStart=0, winEnd=0; // 浣跨敤鏈嶅姟绔椂闂寸獥鍙ｏ紝閬垮厤瀹㈡埛绔椂閽熷亸宸?

function nowSec(){ return Math.floor(Date.now()/1000); }
function windowSecs(){ return range==='24h'? 24*3600 : (range==='1h'? 3600 : 300); }
function rangeSince(){ return nowSec() - windowSecs(); }
function setWindowAll(t0, t1){ winStart=t0; winEnd=t1; cpuC.setWindow(t0,t1); memC.setWindow(t0,t1); diskC.setWindow(t0,t1); gpuUtilC.setWindow(t0,t1); gpuTempC.setWindow(t0,t1); }
function fmtTs(ts){ if(!ts && ts!==0) return '-'; const d=new Date(Number(ts)*1000); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }

async function refreshGPU(){
  try{
    const g = await apiGet('/api/system/gpu');
    const gs = g.gpus||[]; gpuInfo.textContent = (gs.length||0) + ' 脳 GPU';
    if(gs.length){
      const util = gs.map(x=>Number(x.util||0)).filter(x=>!isNaN(x));
      const temp = gs.map(x=>Number(x.temp||0)).filter(x=>!isNaN(x));
      const avgUtil = util.length ? util.reduce((a,b)=>a+b,0)/util.length : 0;
      const avgTemp = temp.length ? temp.reduce((a,b)=>a+b,0)/temp.length : 0;
      gpuVal.textContent = Number(avgUtil).toFixed(0)+'%';
      gpuUtilC.push(avgUtil, nowSec()); gpuTempC.push(avgTemp, nowSec());
    } else { gpuVal.textContent='-'; }
  }catch(e){ gpuVal.textContent='-'; gpuInfo.textContent='-'; }
}

async function refreshAlerts(){
  try{
    const r = await apiGet('/api/alerts');
    const items = (r.items||[]).filter(x=>['CRITICAL','ERROR','SEVERE','FATAL'].includes(String(x.level||'').toUpperCase()));
    const now = Date.now();
    const within = items.filter(x=>{ const t=new Date((x.created_at||'').replace(' ','T')).getTime(); return !isNaN(t)&&(now-t)<=24*3600*1000; }).slice(0,10);
    sevAlerts.innerHTML = within.map(x=>`<tr><td>${x.id}</td><td>${x.level}</td><td>${x.title}</td><td>${x.created_at}</td><td>${x.acknowledged?'宸茬‘璁?:'寰呭鐞?}</td></tr>`).join('') || '<tr><td colspan=5>鏆傛棤涓ラ噸鍛婅</td></tr>';
    const processing = within.filter(x=>!x.acknowledged).length; alertVal.textContent = within.length; alertInfo.textContent = processing?('澶勭悊涓?'+processing):'鏃犳湭纭';
  }catch(e){ sevAlerts.innerHTML = '<tr><td colspan=5>鍔犺浇澶辫触</td></tr>'; }
}

async function sampleProcessTop(){
  procTop.innerHTML = '<tr><td colspan=5>閲囨牱涓紙30s锛?..</td></tr>';
  try{
    const r = await apiGet('/api/process/top?duration=30&limit=10');
    procTop.innerHTML = (r.items||[]).map(p=>`<tr><td>${p.pid}</td><td>${p.name}</td><td>${p.user||''}</td><td>${(p.cpu||0).toFixed(1)}</td><td>${formatBytes(p.mem_rss||0)}</td></tr>`).join('') || '<tr><td colspan=5>鏃犳暟鎹?/td></tr>';
  }catch(e){ procTop.innerHTML = '<tr><td colspan=5>閲囨牱澶辫触</td></tr>'; }
}
document.getElementById('sampleTop').onclick = sampleProcessTop;

async function loadHistory(){
  const myId = ++loadId;
  const since = rangeSince(), until = nowSec();
  const fields = 'cpu_percent,mem_percent,disk_mb_s,gpu_util_avg,gpu_temp_avg';
  const r = await apiGet(`/api/metrics/system?start=${since}&end=${until}&fields=${fields}`);
  const raw = (r && r.items) ? r.items : [];

  // 鍥哄畾绐楀彛鍒拌姹傜獥鍙ｏ紝纭繚妯酱涓ユ牸瑕嗙洊鏁存鏃堕棿
  setWindowAll(since, until);

  // 璋冭瘯寮圭獥锛氭渶杩?1 灏忔椂锛堜粎鍦?DEBUG_POPUPS 涓?true 鏃跺脊鍑猴級
  if (DEBUG_POPUPS && range === '1h'){
    const tsList = raw.map(it=>Number(it.ts||0)).filter(x=>x>=since && x<=until).sort((a,b)=>a-b);
    const minTs = tsList.length? tsList[0] : null; const maxTs = tsList.length? tsList[tsList.length-1] : null;
    let intervalSec = 5; if (tsList.length>=2){ const deltas=[]; for(let i=1;i<tsList.length;i++){ const d=tsList[i]-tsList[i-1]; if(d>0&&isFinite(d)) deltas.push(d);} deltas.sort((a,b)=>a-b); if(deltas.length){ const mid=Math.floor(deltas.length/2); intervalSec = deltas.length%2? deltas[mid] : Math.round((deltas[mid-1]+deltas[mid])/2); intervalSec=Math.max(1,Math.round(intervalSec)); } }
    const expected = Math.floor((until-since)/intervalSec)+1; let missing=0; for(let i=1;i<tsList.length;i++){ const d=tsList[i]-tsList[i-1]; if(d>intervalSec){ missing += Math.max(0, Math.round(d/intervalSec)-1); } }
    const approxMissing = Math.max(0, expected - tsList.length);
    alert([`[璋冭瘯] 璇锋眰绐楀彛(1h): ${fmtTs(since)} ~ ${fmtTs(until)}`, `杩斿洖鏉℃暟: ${tsList.length}`, `杩斿洖鑼冨洿: ${fmtTs(minTs)} ~ ${fmtTs(maxTs)}`, `浼扮畻閲囨牱闂撮殧: ${intervalSec}s`, `鐞嗚鏉℃暟(浼扮畻): ${expected}`, `浼扮畻缂哄け妲戒綅: ${missing}锛堟垨鐞嗚-瀹為檯鈮?{approxMissing}锛塦, `鏄惁瀛樺湪缂哄け: ${(missing>0||approxMissing>0)?'鏄?:'鍚?}`].join('\n'));
  }
  // 璋冭瘯寮圭獥锛氭渶杩?24 灏忔椂锛堜粎鍦?DEBUG_POPUPS 涓?true 鏃跺脊鍑猴級
  if (DEBUG_POPUPS && range === '24h'){
    const tsList = raw.map(it=>Number(it.ts||0)).filter(x=>x>=since && x<=until).sort((a,b)=>a-b);
    const minTs = tsList.length? tsList[0] : null; const maxTs = tsList.length? tsList[tsList.length-1] : null;
    let intervalSec = 5; if (tsList.length>=2){ const deltas=[]; for(let i=1;i<tsList.length;i++){ const d=tsList[i]-tsList[i-1]; if(d>0&&isFinite(d)) deltas.push(d);} deltas.sort((a,b)=>a-b); if(deltas.length){ const mid=Math.floor(deltas.length/2); intervalSec = deltas.length%2? deltas[mid] : Math.round((deltas[mid-1]+deltas[mid])/2); intervalSec=Math.max(1,Math.round(intervalSec)); } }
    const expected = Math.floor((until-since)/intervalSec)+1; let missing=0; for(let i=1;i<tsList.length;i++){ const d=tsList[i]-tsList[i-1]; if(d>intervalSec){ missing += Math.max(0, Math.round(d/intervalSec)-1); } }
    const approxMissing = Math.max(0, expected - tsList.length);
    alert([`[璋冭瘯] 璇锋眰绐楀彛(24h): ${fmtTs(since)} ~ ${fmtTs(until)}`, `杩斿洖鏉℃暟: ${tsList.length}`, `杩斿洖鑼冨洿: ${fmtTs(minTs)} ~ ${fmtTs(maxTs)}`, `浼扮畻閲囨牱闂撮殧: ${intervalSec}s`, `鐞嗚鏉℃暟(浼扮畻): ${expected}`, `浼扮畻缂哄け妲戒綅: ${missing}锛堟垨鐞嗚-瀹為檯鈮?{approxMissing}锛塦, `鏄惁瀛樺湪缂哄け: ${(missing>0||approxMissing>0)?'鏄?:'鍚?}`].join('\n'));
  }

  if (myId !== loadId) return; // 寮傛骞跺彂淇濇姢

  const filtered = raw.filter(it=> Number(it.ts||0) >= since && Number(it.ts||0) <= until).sort((a,b)=>a.ts-b.ts);
  // 24h 瑙嗗浘鍋氱瓑姝ユ娊鏍凤紝閬垮厤鐐瑰お澶氬奖鍝嶅墠绔?
  let points = filtered;
  if (range==='24h'){
    const step = Math.ceil((filtered.length||1)/720); if (step>1){ const tmp=[]; for(let i=0;i<filtered.length;i+=step) tmp.push(filtered[i]); points = tmp; }
  }
  // 濉厖鍥捐〃
  cpuC.data=[]; memC.data=[]; diskC.data=[]; gpuUtilC.data=[]; gpuTempC.data=[];
  let maxDisk=0, sumCpu=0, sumMem=0, sumDisk=0, cnt=0;
  for (const it of points){ const ts=Number(it.ts||0); const cpu=Number(it.cpu_percent||0); const mem=Number(it.mem_percent||0); const dsk=Number(it.disk_mb_s||0); const gu=Number(it.gpu_util_avg||0); const gt=Number(it.gpu_temp_avg||0);
    cpuC.push(isFinite(cpu)?cpu:0, ts); memC.push(isFinite(mem)?mem:0, ts); diskC.push(isFinite(dsk)?dsk:0, ts); gpuUtilC.push(isFinite(gu)?gu:0, ts); gpuTempC.push(isFinite(gt)?gt:0, ts);
    if (isFinite(dsk)) maxDisk = Math.max(maxDisk, dsk);
  }
  for (const it of filtered){ sumCpu+=Number(it.cpu_percent||0); sumMem+=Number(it.mem_percent||0); sumDisk+=Number(it.disk_mb_s||0); cnt++; }
  // 璋冩暣纾佺洏杞?
  const targetMax = maxDisk>0 ? Math.min(maxDisk*1.3, 5000) : 50; diskC.setRange(0, targetMax);
  diskC.ticks = (function(max){ const m=Math.min(Math.max(Math.ceil(max),10),5000); const out=[]; let step=10; if(m<=50)step=10; else if(m<=100)step=20; else if(m<=200)step=50; else if(m<=500)step=100; else if(m<=1000)step=200; else step=500; for(let v=0; v<=m; v+=step) out.push(v); if(out[out.length-1]!==m) out.push(m); return out; })(targetMax);

  // 鍘嗗彶鍔犺浇瀹屾垚鍚庯紝绐楀彛浠嶄繚鎸?[since,until]锛岀敱 SSE 鍐嶅钩婊戞粴鍔紙鍩轰簬鏈嶅姟绔?ts锛?
  lastAvgCpu = cnt? (sumCpu/cnt) : 0; lastAvgMem = cnt? (sumMem/cnt) : 0; lastAvgDisk = cnt? (sumDisk/cnt) : 0;
  document.getElementById('avgCpu').textContent = `${(lastAvgCpu||0).toFixed(1)}% 骞冲潎`;
  document.getElementById('avgMem').textContent = `${(lastAvgMem||0).toFixed(1)}% 骞冲潎`;
  document.getElementById('avgDisk').textContent = `${(lastAvgDisk||0).toFixed(1)} MB/s 骞冲潎`;
}

function startRealtime(){ sseRef = mountSSE('/sse/metrics', (d,e)=>{ if(e.type==='metrics') handleMetricsSnap(d); }); }

function handleMetricsSnap(s){
  const cpuv = Number(s.cpu_percent||0); cpuVal.textContent = isFinite(cpuv)? cpuv.toFixed(0)+'%' : '-';
  let memv = (s.mem_percent!=null && isFinite(Number(s.mem_percent))) ? Number(s.mem_percent) : (function(){ const used=Number(s.mem && s.mem.used != null ? s.mem.used : 0); const total=Number(s.mem && s.mem.total != null ? s.mem.total : 0); if (!total || !isFinite(used)||!isFinite(total)) return 0; return used/total*100; })();
  if (!isFinite(memv)) memv = 0; memVal.textContent = memv.toFixed(0)+'%';
  const totalGb = Number(s.mem && s.mem.total != null ? s.mem.total : 0) / 1073741824; memTotal.textContent = (isFinite(totalGb)? totalGb : 0).toFixed(0)+' GB';
  const ts = Number(s.time || s.ts || nowSec());
  // 浣跨敤鏈嶅姟绔?ts 骞虫粦婊氬姩绐楀彛锛岄伩鍏嶅鎴风鏃堕挓鍋忓樊
  const w = windowSecs();
  setWindowAll(ts - w, ts);
  cpuC.push(isFinite(cpuv)?cpuv:0, ts); memC.push(memv, ts);
  const dsk = Number(s.disk_mb_s||0); diskC.push(isFinite(dsk)?dsk:0, ts);
  const gu = Number(s.gpu_util_avg||0), gt = Number(s.gpu_temp_avg||0); gpuVal.textContent = isFinite(gu)? gu.toFixed(0)+'%' : '-';
  gpuUtilC.push(isFinite(gu)?gu:0, ts); gpuTempC.push(isFinite(gt)?gt:0, ts);
  document.getElementById('avgCpu').textContent = `${Number(cpuv||0).toFixed(1)}% 褰撳墠 | ${(lastAvgCpu||0).toFixed(1)}% 骞冲潎`;
  document.getElementById('avgMem').textContent = `${Number(memv||0).toFixed(1)}% 褰撳墠 | ${(lastAvgMem||0).toFixed(1)}% 骞冲潎`;
}

document.getElementById('rangeSeg').addEventListener('click', async (e)=>{
  const b = e.target.closest('button'); if(!b) return; document.getElementById('rangeSeg').querySelectorAll('button').forEach(x=>x.classList.remove('on')); b.classList.add('on');
  range = b.dataset.r; if (sseRef && typeof sseRef.close==='function'){ try{ sseRef.close(); }catch(_){} sseRef=null; }
  await loadHistory(); startRealtime();
});

refreshGPU(); setInterval(refreshGPU, 3000);
refreshAlerts(); setInterval(refreshAlerts, 10000);
sampleProcessTop();
(async()=>{ await loadHistory(); startRealtime(); })();
</script>
{% endblock %}
