{% extends "base.html" %}{% set page_title="仪表盘" %}{% block content %}
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4" id="kpis">
  <div class="kpi card cpu">
    <div class="kpi-label">CPU 使用率</div>
    <div class="kpi-value" id="cpuVal">-</div>
    <div class="kpi-pill"><span id="cpuInfo">-</span></div>
  </div>
  <div class="kpi card mem">
    <div class="kpi-label">内存占用</div>
    <div class="kpi-value" id="memVal">-</div>
    <div class="kpi-pill"><span id="memTotal">-</span></div>
  </div>
  <div class="kpi card gpu">
    <div class="kpi-label">GPU 总体利用</div>
    <div class="kpi-value" id="gpuVal">-</div>
    <div class="kpi-pill"><span id="gpuInfo">-</span></div>
  </div>
  <div class="kpi card alerts">
    <div class="kpi-label">告警（24h）</div>
    <div class="kpi-value" id="alertVal">-</div>
    <div class="kpi-pill"><span id="alertInfo">-</span></div>
  </div>
</div>

<div class="flex" style="gap:10px;align-items:center;margin-top:10px">
  <span class="small" style="color:var(--muted)">时间范围：</span>
  <div class="seg" id="rangeSeg">
    <button data-r="5m" class="on">最近5分钟</button>
    <button data-r="1h">最近1小时</button>
    <button data-r="24h">最近24小时</button>
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mt-2">
  <div class="card"><div class='section-title'><span>CPU 实时曲线 <span class='mini-avg' id='avgCpu'></span></span></div><canvas id='cpuChart' style='width:100%;height:220px'></canvas></div>
  <div class="card"><div class='section-title'><span>内存使用率曲线 <span class='mini-avg' id='avgMem'></span></span></div><canvas id='memChart' style='width:100%;height:220px'></canvas></div>
  <div class="card"><div class='section-title'><span>磁盘 IO（MB/s） <span class='mini-avg' id='avgDisk'></span></span></div><canvas id='diskChart' style='width:100%;height:220px'></canvas></div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
  <div class="card"><div class='section-title'><span>GPU 利用率（平均）</span></div><canvas id='gpuUtilChart' style='width:100%;height:220px'></canvas></div>
  <div class="card"><div class='section-title'><span>GPU 温度（平均）</span></div><canvas id='gpuTempChart' style='width:100%;height:220px'></canvas></div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
  <div class="card">
    <div class="section-title"><span>最近严重告警</span></div>
    <table class="table"><thead><tr><th>ID</th><th>级别</th><th>标题</th><th>时间</th><th>状态</th></tr></thead><tbody id="sevAlerts"></tbody></table>
  </div>
  <div class="card">
    <div class="section-title"><span>进程 TOP（CPU 30s 采样）</span> <button class="btn" id="sampleTop" style="float:right">刷新采样</button></div>
    <div class="small">采样期间请稍候，请勿频繁点击</div>
    <table class="table"><thead><tr><th>PID</th><th>进程</th><th>用户</th><th>CPU%</th><th>内存</th></tr></thead><tbody id="procTop"></tbody></table>
  </div>
</div>

<script type="module">
import {mountSSE, apiGet, $, formatBytes} from "{{ url_for('static', path='assets/common.js') }}";
import { MiniLine } from "{{ url_for('static', path='assets/chart.js') }}";
const cpuVal=$("#cpuVal"), memVal=$("#memVal"), cpuInfo=$("#cpuInfo"), memTotal=$("#memTotal"), gpuVal=$("#gpuVal"), gpuInfo=$("#gpuInfo"), alertVal=$("#alertVal"), alertInfo=$("#alertInfo");
const sevAlerts=$("#sevAlerts"), procTop=$("#procTop");
const cpuC=new MiniLine('cpuChart',{max:720,yMin:0,yMax:100,axes:true,ticks:[0,20,40,60,80,100]});
const memC=new MiniLine('memChart',{max:720,yMin:0,yMax:100,axes:true,ticks:[0,20,40,60,80,100]});
const diskC=new MiniLine('diskChart',{max:720,yMin:0,yMax:50,axes:true,ticks:[0,10,20,30,40,50]});
const gpuUtilC=new MiniLine('gpuUtilChart',{max:720,yMin:0,yMax:100,axes:true,ticks:[0,20,40,60,80,100]});
const gpuTempC=new MiniLine('gpuTempChart',{max:720,yMin:0,yMax:100,axes:true,ticks:[0,20,40,60,80,100]});

let range='5m';
let lastAvgCpu=0, lastAvgMem=0, lastAvgDisk=0;

function ticksFor(max){
  const m = Math.max(10, Math.ceil(max));
  let step = 10;
  if (m <= 50) step = 10; else if (m <= 100) step = 20; else if (m <= 200) step = 50; else if (m <= 500) step = 100; else if (m <= 1000) step = 200; else step = 500;
  const t = [];
  for(let v=0; v<=m; v+=step) t.push(v);
  if (t[t.length-1] !== m) t.push(m);
  return t;
}

function setDiskScale(max){
  const newMax = Math.min(Math.max(Math.ceil(max), 10), 5000);
  diskC.setRange(0, newMax);
  diskC.ticks = ticksFor(newMax);
  diskC.draw();
}
function nowSec(){ return Math.floor(Date.now()/1000); }
function rangeSince(){ return range==='24h'? nowSec()-24*3600 : (range==='1h'? nowSec()-3600 : nowSec()-300); }
function xLabelsFor(){ if(range==='24h') return ['-24h','-12h','now']; if(range==='1h') return ['-60m','-30m','now']; return ['-5m','-2.5m','now']; }
function maxPoints(){ return 720; }
function decimate(arr){ const step=Math.ceil((arr.length||1)/maxPoints()); if(step<=1) return arr; const out=[]; for(let i=0;i<arr.length;i+=step) out.push(arr[i]); return out; }

async function loadCPUInfo(){
  try{ const r = await apiGet('/api/system/summary'); cpuInfo.textContent = (r.cpu.cores_physical||0) + ' 核 / ' + (r.cpu.cores_logical||0) + ' 线程'; }catch(e){ cpuInfo.textContent='-'; }
}
loadCPUInfo();

function renderSnap(s){
  const cpuv=s.cpu_percent||0; const memv=(100*(1-s.mem.available/s.mem.total));
  cpuVal.textContent = Number(cpuv).toFixed(0)+'%';
  memVal.textContent = Number(memv).toFixed(0)+'%';
  memTotal.textContent = (s.mem.total/1073741824).toFixed(0)+' GB';
  cpuC.push(cpuv); memC.push(memv);
  // show 当前 | 平均 for CPU/Mem
  $('#avgCpu').textContent = `${Number(cpuv).toFixed(1)}% 当前 | ${(lastAvgCpu||0).toFixed(1)}% 平均`;
  $('#avgMem').textContent = `${Number(memv).toFixed(1)}% 当前 | ${(lastAvgMem||0).toFixed(1)}% 平均`;
  if(s.disk_mb_s!=null){
    const v = Number(s.disk_mb_s)||0;
    $('#avgDisk').textContent = `${v.toFixed(1)} MB/s 当前` + (lastAvgDisk?` | ${lastAvgDisk.toFixed(1)} MB/s 平均`:'');
    diskC.push(v);
    if(v > (diskC.yMax||50)*0.9){ setDiskScale(v*1.3); }
  }
}

async function refreshGPU(){
  try{
    const g = await apiGet('/api/system/gpu');
    const gs = g.gpus||[];
    gpuInfo.textContent = (gs.length||0) + ' × GPU';
    if(gs.length){
      const util = gs.map(x=>Number(x.util||0)).filter(x=>!isNaN(x));
      const temp = gs.map(x=>Number(x.temp||0)).filter(x=>!isNaN(x));
      const avgUtil = util.length ? util.reduce((a,b)=>a+b,0)/util.length : 0;
      const avgTemp = temp.length ? temp.reduce((a,b)=>a+b,0)/temp.length : 0;
      gpuVal.textContent = Number(avgUtil).toFixed(0)+'%';
      gpuUtilC.push(avgUtil); gpuTempC.push(avgTemp);
    }else{ gpuVal.textContent='-'; }
  }catch(e){ gpuVal.textContent='-'; gpuInfo.textContent='-'; }
}

async function refreshAlerts(){
  try{
    const r = await apiGet('/api/alerts');
    const items = (r.items||[]).filter(x=>['CRITICAL','ERROR','SEVERE','FATAL'].includes(String(x.level||'').toUpperCase()));
    const now = Date.now();
    const within = items.filter(x=>{ const t=new Date((x.created_at||'').replace(' ','T')).getTime(); return !isNaN(t)&&(now-t)<=24*3600*1000; }).slice(0,10);
    sevAlerts.innerHTML = within.map(x=>`<tr><td>${x.id}</td><td>${x.level}</td><td>${x.title}</td><td>${x.created_at}</td><td>${x.acknowledged?'已确认':'待处理'}</td></tr>`).join('') || '<tr><td colspan=5>暂无严重告警</td></tr>';
    const processing = within.filter(x=>!x.acknowledged).length;
    alertVal.textContent = within.length; alertInfo.textContent = processing?('处理中 '+processing):'无未确认';
  }catch(e){ sevAlerts.innerHTML = '<tr><td colspan=5>加载失败</td></tr>'; }
}

async function sampleProcessTop(){
  procTop.innerHTML = '<tr><td colspan=5>采样中（约30s）...</td></tr>';
  try{
    const r = await apiGet('/api/process/top?duration=30&limit=10');
    procTop.innerHTML = (r.items||[]).map(p=>`<tr><td>${p.pid}</td><td>${p.name}</td><td>${p.user||''}</td><td>${(p.cpu||0).toFixed(1)}</td><td>${formatBytes(p.mem_rss||0)}</td></tr>`).join('') || '<tr><td colspan=5>无数据</td></tr>';
  }catch(e){ procTop.innerHTML = '<tr><td colspan=5>采样失败</td></tr>'; }
}

async function loadHistory(){
  const since = rangeSince(), until = nowSec();
  const r = await apiGet(`/api/reports/metrics?since=${since}&until=${until}`);
  let items = r.items||[]; items = decimate(items);
  cpuC.data=[]; memC.data=[]; diskC.data=[]; gpuUtilC.data=[]; gpuTempC.data=[];
  let maxDisk=0;
  items.forEach(it=>{ 
    cpuC.push(it.cpu_percent||0); 
    memC.push(it.mem_percent||0); 
    const dv=Number(it.disk_mb_s||0); maxDisk=Math.max(maxDisk,dv); diskC.push(dv);
    gpuUtilC.push(it.gpu_util_avg||0); gpuTempC.push(it.gpu_temp_avg||0); 
  });
  const targetMax = maxDisk>0 ? maxDisk*1.3 : 50;
  setDiskScale(targetMax);
  const xl = (range==='24h')?['-24h','-12h','now'] : (range==='1h')?['-60m','-30m','now'] : ['-5m','-2.5m','now'];
  cpuC.setXLabels(xl); memC.setXLabels(xl); diskC.setXLabels(xl); gpuUtilC.setXLabels(xl); gpuTempC.setXLabels(xl);
  lastAvgCpu = Number(r.summary.cpu_avg||0);
  lastAvgMem = Number(r.summary.mem_avg||0);
  const lastCpu = cpuC.data.length ? (cpuC.data[cpuC.data.length-1].v||0) : 0;
  const lastMem = memC.data.length ? (memC.data[memC.data.length-1].v||0) : 0;
  $('#avgCpu').textContent = `${Number(lastCpu).toFixed(1)}% 当前 | ${lastAvgCpu.toFixed(1)}% 平均`;
  $('#avgMem').textContent = `${Number(lastMem).toFixed(1)}% 当前 | ${lastAvgMem.toFixed(1)}% 平均`;
  lastAvgDisk = Number(r.summary.disk_avg||0);
  $('#avgDisk').textContent = lastAvgDisk.toFixed(1)+' MB/s 平均';
}

$('#rangeSeg').addEventListener('click', (e)=>{
  const b = e.target.closest('button'); if(!b) return;
  $('#rangeSeg').querySelectorAll('button').forEach(x=>x.classList.remove('on')); b.classList.add('on');
  range = b.dataset.r; loadHistory();
});

mountSSE('/sse/metrics', (d,e)=>{ if(e.type==='metrics') renderSnap(d); });
refreshGPU(); setInterval(refreshGPU, 3000);
refreshAlerts(); setInterval(refreshAlerts, 10000);
sampleProcessTop();
loadHistory();
</script>
{% endblock %}
