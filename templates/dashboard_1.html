{% extends "base.html" %}{% set page_title="仪表盘" %}{% block content %}
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4" id="kpis">
  <div class="kpi card cpu">
    <div class="kpi-label">CPU 使用率</div>
    <div class="kpi-value" id="cpuVal">-</div>
    <div class="kpi-pill"><span id="cpuInfo">-</span></div>
  </div>
  <div class="kpi card mem">
    <div class="kpi-label">内存占用</div>
    <div class="kpi-value" id="memVal">-</div>
    <div class="kpi-pill"><span id="memTotal">-</span></div>
  </div>
  <div class="kpi card gpu">
    <div class="kpi-label">GPU 总体利用</div>
    <div class="kpi-value" id="gpuVal">-</div>
    <div class="kpi-pill"><span id="gpuInfo">-</span></div>
  </div>
  <div class="kpi card alerts">
    <div class="kpi-label">告警（24h）</div>
    <div class="kpi-value" id="alertVal">-</div>
    <div class="kpi-pill"><span class="warn" id="alertInfo">-</span></div>
  </div>
</div>

<div class="flex" style="gap:10px;align-items:center;margin-top:6px"><span class="small">时间范围：</span><div class="seg" id="rangeSeg"><button data-r="1h" class="on">最近1小时</button><button data-r="24h">最近24小时</button></div></div>
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mt-2">
  <div class="card"><div class='section-title'><span>CPU 实时曲线 <span class='mini-avg' id='avgCpu'></span></span></div><canvas id='cpuChart' style='width:100%;height:220px'></canvas></div>
  <div class="card"><div class='section-title'><span>内存使用率曲线 <span class='mini-avg' id='avgMem'></span></span></div><canvas id='memChart' style='width:100%;height:220px'></canvas></div>
</div>

<div class="flex" style="gap:10px;align-items:center;margin-top:6px"><span class="small">时间范围：</span><div class="seg" id="rangeSeg"><button data-r="1h" class="on">最近1小时</button><button data-r="24h">最近24小时</button></div></div>
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mt-2">
  <div class="card"><div class='section-title'><span>GPU 利用率（平均）</span></div><canvas id='gpuUtilChart' style='width:100%;height:220px'></canvas></div>
  <div class="card"><div class='section-title'><span>GPU 温度（平均）</span></div><canvas id='gpuTempChart' style='width:100%;height:220px'></canvas></div>
</div>

<div class="flex" style="gap:10px;align-items:center;margin-top:6px"><span class="small">时间范围：</span><div class="seg" id="rangeSeg"><button data-r="1h" class="on">最近1小时</button><button data-r="24h">最近24小时</button></div></div>
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mt-2">
  <div class="card">
    <div class="section-title"><span>最近严重告警</span></div>
    <table class="table w-full text-sm mt-2"><thead><tr><th>ID</th><th>级别</th><th>标题</th><th>时间</th><th>状态</th></tr></thead><tbody id="sevAlerts"></tbody></table>
  </div>
  <div class="card">
    <div class="flex"><div class="section-title"><span>进程 TOP（CPU 30s 采样）</span></div><div style="margin-left:auto"><button class="btn" id="sampleTop">刷新 30s 采样</button></div></div>
    <div class="small">采样期间请稍候，请勿频繁点击</div>
    <table class="table w-full text-sm mt-2"><thead><tr><th>PID</th><th>进程</th><th>用户</th><th>CPU%</th><th>内存</th></tr></thead><tbody id="procTop"></tbody></table>
  </div>
</div>

<script type="module">
import {mountSSE, apiGet, $, formatBytes} from "{{ url_for('static', path='assets/common.js') }}";
import { MiniLine } from "{{ url_for('static', path='assets/chart.js') }}";

const onReady = () => {
const cpuVal=$("#cpuVal"), memVal=$("#memVal"), cpuInfo=$("#cpuInfo"), memTotal=$("#memTotal"), gpuVal=$("#gpuVal"), gpuInfo=$("#gpuInfo"), alertVal=$("#alertVal"), alertInfo=$("#alertInfo");
const net=$("#net tbody"), disks=$("#disks tbody");
const sevAlerts=$("#sevAlerts"), procTop=$("#procTop");
const cpuC=new MiniLine(document.getElementById('cpuChart'),{max:720,yMin:0,yMax:100,axes:true,ticks:[0,20,40,60,80,100]});
const memC=new MiniLine(document.getElementById('memChart'),{max:720,yMin:0,yMax:100,axes:true,ticks:[0,20,40,60,80,100]});
const gpuUtilC=new MiniLine(document.getElementById('gpuUtilChart'),{max:720,yMin:0,yMax:100,axes:true,ticks:[0,20,40,60,80,100]});
const diskC=new MiniLine(document.getElementById('diskChart'),{max:720,yMin:0,yMax:1000,axes:true,ticks:[0,100,200,400,600,800,1000]});
const gpuTempC=new MiniLine(document.getElementById('gpuTempChart'),{max:720,yMin:0,yMax:100,axes:true,ticks:[0,20,40,60,80,100]});

function toPercent(v){ return Number(v||0).toFixed(0) + '%'; }
function gb(n){ return (n/1073741824).toFixed(0) + ' GB'; }

async function loadCPUInfo(){
  try{
    const r = await apiGet('/api/system/summary');
    const phy = r.cpu.cores_physical || 0, log = r.cpu.cores_logical || 0;
    cpuInfo.textContent = `${phy} 核 / ${log} 线程`;
  }catch(e){ cpuInfo.textContent='-'; }
}
loadCPUInfo();

function renderSnap(s){
  const cpuv=s.cpu_percent||0; const memv=(100*(1-s.mem.available/s.mem.total));
  cpuVal.textContent = toPercent(cpuv);
  memVal.textContent = toPercent(memv);
  memTotal.textContent = gb(s.mem.total);
  cpuC.push(cpuv); memC.push(memv);
}

async function refreshGPU(){
  try{
    const g = await apiGet('/api/system/gpu');
    const gs = g.gpus||[];
    gpuInfo.textContent = (gs.length||0) + ' × GPU';
    if(gs.length){
      const util = gs.map(x=>Number(x.util||0)).filter(x=>!isNaN(x));
      const temp = gs.map(x=>Number(x.temp||0)).filter(x=>!isNaN(x));
      const avgUtil = util.length ? util.reduce((a,b)=>a+b,0)/util.length : 0;
      const avgTemp = temp.length ? temp.reduce((a,b)=>a+b,0)/temp.length : 0;
      gpuVal.textContent = toPercent(avgUtil);
      gpuUtilC.push(avgUtil); gpuTempC.push(avgTemp);
    }else{
      gpuVal.textContent = '-';
    }
  }catch(e){ gpuVal.textContent='-'; gpuInfo.textContent='-'; }
}

async function refreshAlerts(){
  try{
    const r = await apiGet('/api/alerts');
    const items = (r.items||[]).filter(x=>['CRITICAL','ERROR','SEVERE','FATAL'].includes(String(x.level||'').toUpperCase()));
    // 最近（24h）优先，最多 10 条
    const now = Date.now();
    const within = items.filter(x=>{
      const t = new Date(x.created_at.replace(' ','T')).getTime();
      return !isNaN(t) && (now - t) <= 24*3600*1000;
    }).slice(0,10);
    sevAlerts.innerHTML = within.map(x=>`<tr><td>${x.id}</td><td>${x.level}</td><td>${x.title}</td><td>${x.created_at}</td><td>${x.acknowledged?'已确认':'待处理'}</td></tr>`).join('') || '<tr><td colspan=5>暂无严重告警</td></tr>';
  }catch(e){ sevAlerts.innerHTML = '<tr><td colspan=5>加载失败</td></tr>'; }
}

async function sampleProcessTop(){
  procTop.innerHTML = '<tr><td colspan=5>采样中（约30s）...</td></tr>';
  try{
    const r = await apiGet('/api/process/top?duration=30&limit=10');
    procTop.innerHTML = (r.items||[]).map(p=>`<tr><td>${p.pid}</td><td>${p.name}</td><td>${p.user||''}</td><td>${p.cpu.toFixed(1)}</td><td>${formatBytes(p.mem_rss)}</td></tr>`).join('') || '<tr><td colspan=5>无数据</td></tr>';
  }catch(e){ procTop.innerHTML = '<tr><td colspan=5>采样失败</td></tr>'; }
}

document.getElementById('sampleTop').onclick = sampleProcessTop;

mountSSE('/sse/metrics', (d,e)=>{ if(e.type==='metrics') renderSnap(d); });
refreshGPU(); setInterval(refreshGPU, 3000);
refreshAlerts(); setInterval(refreshAlerts, 10000);
sampleProcessTop(); // initial

const rangeSeg = document.getElementById('rangeSeg');
let range = '1h'; // '1h' or '24h'

function nowSec(){ return Math.floor(Date.now()/1000); }
function rangeSince(){ return range==='24h' ? nowSec()-24*3600 : nowSec()-3600; }

async function loadHistory(){
  const since = rangeSince(), until = nowSec();
  const r = await apiGet(`/api/reports/metrics?since=${since}&until=${until}`);
  const items = r.items||[];
  // reset charts
  cpuC.data=[]; memC.data=[]; diskC.data=[]; gpuUtilC.data=[]; gpuTempC.data=[];
  items.forEach(it=>{ cpuC.push(it.cpu_percent||0); memC.push(it.mem_percent||0); diskC.push(it.disk_mb_s||0); gpuUtilC.push(it.gpu_util_avg||0); gpuTempC.push(it.gpu_temp_avg||0); });
  // means
  document.getElementById('avgCpu').textContent = (r.summary.cpu_avg||0).toFixed(1)+'% 平均';
  document.getElementById('avgMem').textContent = (r.summary.mem_avg||0).toFixed(1)+'% 平均';
  document.getElementById('avgDisk').textContent = (r.summary.disk_avg||0).toFixed(1)+' MB/s 平均';
}

rangeSeg.addEventListener('click', (e)=>{
  const b = e.target.closest('button'); if(!b) return;
  rangeSeg.querySelectorAll('button').forEach(x=>x.classList.remove('on'));
  b.classList.add('on'); range = b.dataset.r; loadHistory();
});
loadHistory();
};
if (document.readyState !== 'loading') onReady(); else document.addEventListener('DOMContentLoaded', onReady);

</script>
{% endblock %}
