{% extends "base.html" %}{% set page_title="网络接口" %}{% block content %}
<div class="card">
  <div class="flex" style="align-items:center;gap:10px">
    <div class="section-title"><span>网络接口</span></div>
    <label class="small" style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="upOnly" checked> 仅显示UP</label>
    <div style="margin-left:auto"><button class="btn" id="refresh">刷新</button></div>
  </div>
  <table class="table mt-3"><thead><tr><th>接口</th><th>UP</th><th>速率</th><th>MTU</th><th>地址</th></tr></thead><tbody id="tb"></tbody></table>
  <div class="small mt-2" style="color:var(--muted)">默认聚合整机（__total__）。后续可加接口选择器。</div>
  </div>

<div class="flex" style="gap:10px;align-items:center;margin-top:10px">
  <span class="small" style="color:var(--muted)">时间范围</span>
  <div class="seg" id="rangeSeg">
    <button data-r="1h" class="on">近1小时</button>
    <button data-r="24h">近24小时</button>
  </div>
  <span class="mini-avg" id="rxAvg" style="margin-left:auto"></span>
  <span class="mini-avg" id="txAvg" style="margin-left:12px"></span>
  <span class="mini-avg" id="latLabel" style="margin-left:12px"></span>
  <span class="mini-avg" id="errPerMin" style="margin-left:12px"></span>
  </div>

<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mt-2">
  <div class="kpi card"><div class="kpi-label">下载</div><div class="kpi-value" id="rxNow">-</div><div class="kpi-pill"><span id="rxAvg2">-</span></div></div>
  <div class="kpi card"><div class="kpi-label">上传</div><div class="kpi-value" id="txNow">-</div><div class="kpi-pill"><span id="txAvg2">-</span></div></div>
  <div class="kpi card"><div class="kpi-label">延迟</div><div class="kpi-value" id="latNow">-</div><div class="kpi-pill"><span>当前最新</span></div></div>
  <div class="kpi card"><div class="kpi-label">错误（范围总计）</div><div class="kpi-value" id="errSum">-</div><div class="kpi-pill"><span id="errPerMin2">-</span></div></div>
  </div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
  <div class="card"><div class="section-title"><span id="rxTitle">下载速度</span></div><canvas id="rxChart" style="width:100%;height:220px"></canvas></div>
  <div class="card"><div class="section-title"><span id="txTitle">上传速度</span></div><canvas id="txChart" style="width:100%;height:220px"></canvas></div>
  </div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
  <div class="card"><div class="section-title"><span id="latTitle">网络延迟（ms）</span></div><canvas id="latChart" style="width:100%;height:220px"></canvas></div>
  <div class="card"><div class="section-title"><span id="errTitle">错误计数（次/分钟）</span></div><canvas id="errChart" style="width:100%;height:220px"></canvas></div>
  </div>

<script type="module">
import {apiGet, mountSSE, $} from "{{ url_for('static', path='assets/common.js') }}";
import {MiniLine} from "{{ url_for('static', path='assets/chart.js') }}";

// x轴时间刻度（同仪表盘）
function genXTicks(t0, t1){ const N=5, out=[]; for(let i=0;i<N;i++){ const p=i/(N-1); const dt=(t1-t0)*(1-p); let label='now'; if(dt>0){ if(dt>=3600) label=`-${Math.round(dt/3600)}h`; else if(dt>=60){ const m=Math.round((dt/60)*10)/10; label=`-${String(m).replace(/\.0$/,'')}m`; } else label=`-${Math.round(dt)}s`; } out.push({p,label}); } return out; }

// 图表：启用 timeMode，与窗口同步
const rxC=new MiniLine('rxChart',{timeMode:true,max:720,yMin:0,yMax:100,axes:true,ticks:[0,25,50,75,100],xTicks:genXTicks});
const txC=new MiniLine('txChart',{timeMode:true,max:720,yMin:0,yMax:100,axes:true,ticks:[0,25,50,75,100],xTicks:genXTicks});
const latC=new MiniLine('latChart',{timeMode:true,max:720,yMin:0,yMax:200,axes:true,ticks:[0,50,100,150,200],xTicks:genXTicks});
const errC=new MiniLine('errChart',{timeMode:true,max:720,yMin:0,yMax:10,axes:true,ticks:[0,5,10],xTicks:genXTicks});

let range='1h'; let sseRef=null; let lastNetTs=0; let lastErrIn=0, lastErrOut=0; let lastUnit='KB/s'; let unitFactor=1; let winStart=0, winEnd=0;
const fmt = (v)=> (Math.abs(v)>=100? v.toFixed(0) : v.toFixed(1));
const nowSec=()=> Math.floor(Date.now()/1000);
const windowSecs=()=> range==='24h'? 24*3600 : 3600; // 1h
function setWindowAll(t0,t1){ winStart=t0; winEnd=t1; rxC.setWindow(t0,t1); txC.setWindow(t0,t1); latC.setWindow(t0,t1); errC.setWindow(t0,t1); }
function niceNumber(x, round){ if(!isFinite(x)||x<=0) return 1; const exp=Math.floor(Math.log10(x)); const f=x/Math.pow(10,exp); let nf; if(round){ nf=(f<1.5)?1:(f<3)?2:(f<7)?5:10; } else { nf=(f<=1)?1:(f<=2)?2:(f<=5)?5:10; } return nf*Math.pow(10,exp); }
function genNiceYTicks(max, desired=6){ const cap=Math.min(Math.max(max,10),5000); const range=cap; const niceRange=niceNumber(range,false); const spacing=Math.max(1e-12, niceNumber(niceRange/Math.max(2,desired-1),true)); const top=Math.ceil(cap/spacing)*spacing; const out=[]; for(let v=0; v<=top+spacing*0.5; v+=spacing) out.push(Number(v.toFixed(10))); return out; }

async function loadMeta(){
  const meta = await apiGet('/api/network/meta');
  const upOnly = !!(document.getElementById('upOnly')?.checked);
  const entries = Object.entries(meta.ifaces||{}).filter(([k,v])=> upOnly ? !!v.isup : true);
  const tb = document.getElementById('tb');
  tb.innerHTML = entries.map(([k,v])=>{
    const addrs = (v.addrs||[]).map(a=>a.address).join('<br>');
    const up = v.isup ? '是' : '否';
    const def = (meta.primary_iface===k) ? ' <span class="small" style="color:var(--muted)">(默认)</span>' : '';
    return `<tr><td>${k}${def}</td><td>${up}</td><td>${v.speed||'-'}</td><td>${v.mtu||'-'}</td><td>${addrs}</td></tr>`;
  }).join('') || '<tr><td colspan=5>无数据</td></tr>';
}

function applyYScales(rxMax, txMax, latMax, errMax){
  const rxTicks=genNiceYTicks(rxMax,6); rxC.setRange(0, rxTicks[rxTicks.length-1]); rxC.ticks=rxTicks; rxC.setXLabels(genXTicks(winStart,winEnd));
  const txTicks=genNiceYTicks(txMax,6); txC.setRange(0, txTicks[txTicks.length-1]); txC.ticks=txTicks; txC.setXLabels(genXTicks(winStart,winEnd));
  const ltTicks=genNiceYTicks(latMax,6); latC.setRange(0, ltTicks[ltTicks.length-1]); latC.ticks=ltTicks; latC.setXLabels(genXTicks(winStart,winEnd));
  const erTicks=genNiceYTicks(errMax,6); errC.setRange(0, erTicks[erTicks.length-1]); errC.ticks=erTicks; errC.setXLabels(genXTicks(winStart,winEnd));
}

async function loadHistory(){
  const iface='__total__';
  const end=nowSec();
  const start=end - windowSecs();
  setWindowAll(start, end);
  const fields='ts,rx_kbps,tx_kbps,latency_ms,errin,errout';
  const r = await apiGet(`/api/metrics/network?iface=${encodeURIComponent(iface)}&start=${start}&end=${end}&fields=${fields}`);
  let items=(r&&r.items)?r.items:[];
  // Downsample 24h to ~720 points to avoid lag
  if (range==='24h' && items.length>720){ const step=Math.ceil(items.length/720); const tmp=[]; for(let i=0;i<items.length;i+=step) tmp.push(items[i]); if(tmp[tmp.length-1]!==items[items.length-1]) tmp.push(items[items.length-1]); items=tmp; }
  // Decide unit before pushing
  let histMaxKBps=0; for(const it of items){ const rx=Number(it.rx_kbps||0), tx=Number(it.tx_kbps||0); histMaxKBps=Math.max(histMaxKBps, rx, tx); }
  if(histMaxKBps>=1024){ lastUnit='MB/s'; unitFactor=1/1024; } else { lastUnit='KB/s'; unitFactor=1; }
  // Clear and push with chosen unit
  rxC.data=[]; txC.data=[]; latC.data=[]; errC.data=[];
  let maxRx=10, maxTx=10, maxLat=200, maxErr=5; let errSum=0;
  let prevErrIn=null, prevErrOut=null, prevTs=null; lastErrIn=0; lastErrOut=0; lastNetTs=0;
  for (const it of items){
    const ts=Number(it.ts||0); const rx=Number(it.rx_kbps||0)*unitFactor; const tx=Number(it.tx_kbps||0)*unitFactor; const lt=Number(it.latency_ms||0); const ein=Number(it.errin||0); const eout=Number(it.errout||0);
    rxC.push(isFinite(rx)?rx:0, ts); txC.push(isFinite(tx)?tx:0, ts); latC.push(isFinite(lt)?lt:0, ts);
    if(prevErrIn!=null && prevErrOut!=null && prevTs!=null && ts>prevTs){ const d=(Math.max(0,ein-prevErrIn)+Math.max(0,eout-prevErrOut)); const perMin = d * (60/Math.max(1, ts-prevTs)); errC.push(perMin, ts); maxErr=Math.max(maxErr, perMin); errSum += d; }
    prevErrIn=ein; prevErrOut=eout; prevTs=ts;
    maxRx=Math.max(maxRx, rx); maxTx=Math.max(maxTx, tx); if(lt>0) maxLat=Math.max(maxLat, lt);
  }
  applyYScales(maxRx, maxTx, maxLat, maxErr);
  // Titles + KPIs
  const last = items.length? items[items.length-1] : null;
  const lastRX = last? Number(last.rx_kbps||0)*unitFactor : 0;
  const lastTX = last? Number(last.tx_kbps||0)*unitFactor : 0;
  const lastLT = last? Number(last.latency_ms||0) : 0;
  $('#rxTitle').textContent=`下载速度（${lastUnit}）` + (range==='24h'?'（近24小时）':'（近1小时）');
  $('#txTitle').textContent=`上传速度（${lastUnit}）` + (range==='24h'?'（近24小时）':'（近1小时）');
  $('#latTitle').textContent='网络延迟（ms）' + (range==='24h'?'（近24小时）':'（近1小时）');
  $('#errTitle').textContent='错误计数（次/分钟）' + (range==='24h'?'（近24小时）':'（近1小时）');
  $('#rxNow').textContent=`${fmt(lastRX)} ${lastUnit}`; $('#txNow').textContent=`${fmt(lastTX)} ${lastUnit}`; $('#latNow').textContent=isFinite(lastLT)? `${fmt(lastLT)} ms`:'-';
  let srx=0, stx=0; let n=0; for(const it of items){ srx+=Number(it.rx_kbps||0); stx+=Number(it.tx_kbps||0); n++; }
  const rxAvg=(n? srx/n:0)*unitFactor, txAvg=(n? stx/n:0)*unitFactor;
  $('#rxAvg').textContent=`平均 ${fmt(rxAvg)} ${lastUnit}`; $('#txAvg').textContent=`平均 ${fmt(txAvg)} ${lastUnit}`;
  $('#rxAvg2').textContent=`平均 ${fmt(rxAvg)} ${lastUnit}`; $('#txAvg2').textContent=`平均 ${fmt(txAvg)} ${lastUnit}`;
  $('#errSum').textContent=`${errSum}`;
}

function startRealtime(){
  if(sseRef && typeof sseRef.close==='function'){ try{ sseRef.close(); }catch(_){} }
  const iface='__total__';
  sseRef = mountSSE(`/sse/network?iface=${encodeURIComponent(iface)}`, (d)=>{
    const ts = Number(d.ts||d.time||nowSec());
    const rx = Number(d.rx_kbps||0), tx = Number(d.tx_kbps||0), lt = Number(d.latency_ms||0);
    const ein = Number(d.errin||0), eout = Number(d.errout||0);
    const w = windowSecs(); setWindowAll(ts - w, ts);
    rxC.push(rx*unitFactor, ts); txC.push(tx*unitFactor, ts); if(isFinite(lt) && lt>0) latC.push(lt, ts);
    if(lastNetTs && ts>lastNetTs){ const dErr=Math.max(0,ein-lastErrIn)+Math.max(0,eout-lastErrOut); const perMin = dErr * (60/Math.max(1, ts-lastNetTs)); errC.push(perMin, ts); const sumNow=Number(document.getElementById('errSum').textContent||'0')||0; document.getElementById('errSum').textContent=String(sumNow + dErr); }
    lastNetTs=ts; lastErrIn=ein; lastErrOut=eout;
    $('#rxNow').textContent = `${fmt(rx*unitFactor)} ${lastUnit}`;
    $('#txNow').textContent = `${fmt(tx*unitFactor)} ${lastUnit}`;
    if(isFinite(lt)) $('#latNow').textContent = `${fmt(lt)} ms`;
  });
}

document.getElementById('rangeSeg')?.addEventListener('click', async (e)=>{
  const b=e.target.closest('button'); if(!b) return; const seg=document.getElementById('rangeSeg'); seg.querySelectorAll('button').forEach(x=>x.classList.remove('on')); b.classList.add('on');
  range=b.dataset.r; await loadHistory(); startRealtime();
});

document.getElementById('upOnly')?.addEventListener('change', ()=>{ loadMeta(); });
document.getElementById('refresh')?.addEventListener('click', ()=>{ loadMeta(); });

await loadMeta();
await loadHistory();
startRealtime();
setInterval(loadMeta, 10000);
</script>
{% endblock %}
