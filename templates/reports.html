{% extends "base.html" %}{% set page_title="数据报表" %}{% block content %}
<div class="card">
  <div class="section-title"><span>筛选条件</span></div>

  <!-- Row 1: 指标切换 + 导出 -->
  <div class="mt-2" style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap">
    <span class="muted">指标：</span>
    <div class="seg" id="metricTabs">
      <button data-m="cpu" class="on">CPU</button>
      <button data-m="mem">内存</button>
      <button data-m="gpu">GPU</button>
      <button data-m="load">负载</button>
      <button data-m="proc">进程</button>
      <button data-m="diskio">磁盘 IO</button>
      <button data-m="net_total">网络</button>
    </div>
    <div style="margin-left:auto;display:flex;gap:.5rem;align-items:center">
      <a id="dl-active" class="btn secondary" target="_blank">导出 CSV</a>
    </div>
  </div>

  <!-- Row 2: 时间 + 快捷范围 + 查询 -->
  <div class="mt-2" style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap">
    <label>开始</label>
    <input type="datetime-local" class="input" id="start" style="width:260px">
    <span class="muted">至</span>
    <label>结束</label>
    <input type="datetime-local" class="input" id="end" style="width:260px">
    <div class="seg" id="quickRanges">
      <button class="on" data-range="1h">近1小时</button>
      <button data-range="6h">近6小时</button>
      <button data-range="24h">近24小时</button>
      <button data-range="7d">近7天</button>
    </div>
    <button class="btn" id="btn-go" style="margin-left:auto">查询</button>
  </div>

  <div class="mt-1 muted" id="range-note"></div>
  <div class="mt-1 muted" id="summary"></div>
</div>

<div class="card" id="activeCard">
  <div class="section-title"><span id="activeTitle">CPU</span></div>
  <table class="table mt-2"><thead id="thead"></thead><tbody id="tb"></tbody></table>
  <div class="mt-1 muted" id="sum-active"></div>
</div>

<script type="module">
import {apiGet,$,formatBytes} from "{{ url_for('static', path='assets/common.js') }}";

const state = { active:'cpu', data:null };
function toEpoch(input){ const v=input.value; if(!v) return null; const d=new Date(v); return Math.floor(d.getTime()/1000); }
function setRangeHours(hours){ const now=new Date(); const start=new Date(now.getTime()-hours*3600*1000); const fmt=(d)=>{ const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; }; $('#start').value=fmt(start); $('#end').value=fmt(now); }
function human(ts){ return new Date((ts||0)*1000).toLocaleString(); }
// Format datetime-local value to normal date string: YYYY-MM-DD HH:MM
function fmtLocalInput(v){ if(!v) return ''; const d=new Date(v); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function updateRangeNote(){ const s=$('#start').value, e=$('#end').value; document.getElementById('range-note').textContent = `查询范围：${fmtLocalInput(s)} - ${fmtLocalInput(e)}`; }

function setExportLink(){ const qs=(p)=>Object.entries(p).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&'); const range={ start: $('#start').value, end: $('#end').value }; $('#dl-active').href = `/api/reports/export.csv?${qs({metric: state.active, ...range})}`; }

function renderActive(){
  if(!state.data) return; const r=state.data; const active=state.active; const thead=$('#thead'); const tb=$('#tb'); const ttl=$('#activeTitle'); const sum=$('#sum-active');
  const fill=(rows, cols, headers)=>{ thead.innerHTML = `<tr><th>时间</th>${headers.map(h=>`<th>${h}</th>`).join('')}</tr>`; tb.innerHTML = (rows||[]).map(x=>`<tr><td>${human(x.ts)}</td>${cols.map(k=>{ let v=x[k]; if(k==='mem_used'||k==='mem_total') v=formatBytes(v||0); if(typeof v==='number') v = (Number.isInteger(v)? v : v.toFixed(2)); return `<td>${v??''}</td>`; }).join('')}</tr>`).join(''); };
  if(active==='cpu'){ ttl.textContent='CPU'; fill(r.cpu,['cpu_percent'],['CPU%']); sum.textContent=`样本数 ${r.cpu?.length||0}；CPU 平均 ${(r.summary?.cpu_avg||0).toFixed(2)}%`; }
  else if(active==='mem'){ ttl.textContent='内存'; thead.innerHTML='<tr><th>时间</th><th>内存%</th><th>已用</th><th>总计</th></tr>'; tb.innerHTML=(r.mem||[]).map(x=>`<tr><td>${human(x.ts)}</td><td>${(x.mem_percent??0).toFixed(1)}</td><td>${formatBytes(x.mem_used||0)}</td><td>${formatBytes(x.mem_total||0)}</td></tr>`).join(''); sum.textContent=`样本数 ${r.mem?.length||0}；内存平均 ${(r.summary?.mem_avg||0).toFixed(1)}%`; }
  else if(active==='gpu'){ ttl.textContent='GPU'; fill(r.gpu,['gpu_util_avg','gpu_temp_avg'],['利用率%','温度℃']); sum.textContent=`GPU 利用率均值 ${(r.summary?.gpu_util_avg||0).toFixed(1)}%，温度均值 ${(r.summary?.gpu_temp_avg||0).toFixed(0)}℃`; }
  else if(active==='load'){ ttl.textContent='负载'; fill(r.load,['load1','load5','load15'],['load1','load5','load15']); sum.textContent=''; }
  else if(active==='proc'){ ttl.textContent='进程'; fill(r.proc,['processes'],['进程数']); sum.textContent=`进程平均 ${(r.summary?.procs_avg||0).toFixed(0)}`; }
  else if(active==='diskio'){ ttl.textContent='磁盘 IO'; fill(r.diskio,['disk_mb_s'],['MB/s']); sum.textContent=`磁盘 IO 平均 ${(r.summary?.disk_avg||0).toFixed(1)} MB/s`; }
  else if(active==='net_total'){ ttl.textContent='网络（总计）'; fill(r.net_total,['rx_kbps','tx_kbps','latency_ms'],['下行 KB/s','上行 KB/s','延迟 ms']); sum.textContent=`网络 平均下行 ${(r.summary?.net_rx_avg||0).toFixed(1)} KB/s，上行 ${(r.summary?.net_tx_avg||0).toFixed(1)} KB/s，延迟 ${(r.summary?.latency_avg||0).toFixed(0)} ms`; }
  setExportLink();
}

async function load(){ const s=toEpoch($('#start')); const e=toEpoch($('#end')); const url=`/api/reports/series?start=${s||''}&end=${e||''}`; const r=await apiGet(url); state.data=r; document.getElementById('range-note').textContent = `查询范围：${fmtLocalInput($('#start').value)} - ${fmtLocalInput($('#end').value)}`; document.getElementById('summary').textContent = `磁盘 IO 平均 ${(r.summary?.disk_avg||0).toFixed(1)} MB/s；GPU 利用率均值 ${(r.summary?.gpu_util_avg||0).toFixed(1)}% / 温度均值 ${(r.summary?.gpu_temp_avg||0).toFixed(0)}℃；网络(总计) 平均下行 ${(r.summary?.net_rx_avg||0).toFixed(1)} KB/s，上行 ${(r.summary?.net_tx_avg||0).toFixed(1)} KB/s，延迟 ${(r.summary?.latency_avg||0).toFixed(0)} ms`; renderActive(); }

// init
setRangeHours(1);
$('#btn-go').onclick=()=>{ load().then(updateRangeNote); };
document.querySelectorAll('#quickRanges button[data-range]').forEach(btn=>{
  btn.onclick=()=>{ document.querySelectorAll('#quickRanges button').forEach(x=>x.classList.remove('on')); btn.classList.add('on'); const v=btn.getAttribute('data-range'); if(v.endsWith('h')) setRangeHours(parseInt(v)); else if(v.endsWith('d')) setRangeHours(parseInt(v)*24); load().then(updateRangeNote); };
});
document.getElementById('metricTabs').addEventListener('click', (e)=>{ const b=e.target.closest('button'); if(!b) return; const tabs=document.querySelectorAll('#metricTabs button'); tabs.forEach(x=>x.classList.remove('on')); b.classList.add('on'); state.active=b.getAttribute('data-m'); renderActive(); });
load().then(updateRangeNote);
</script>
{% endblock %}

